<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Theo Dõi Đơn Hàng - T2K Coffee</title>
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/components.css">
  <link rel="stylesheet" href="../assets/css/status.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  <div id="app">
    <div id="header-container"></div>
    
    <main class="status-page">
      <div class="container">
        <h1>Theo Dõi Đơn Hàng</h1>

        <div class="status-container">
          <div class="order-card" id="currentOrder">
            <h3>Đơn Hàng Hiện Tại</h3>
            <div class="order-details">
              <p><strong>Mã đơn hàng:</strong> <span id="orderId"></span></p>
              <p><strong>Bàn:</strong> <span id="orderTable"></span></p>
              <p><strong>Thời gian đặt:</strong> <span id="orderTime"></span></p>
              <p><strong>Trạng thái:</strong> <span class="status-badge status-processing" id="orderStatus">Đang xử lý</span></p>
            </div>

            <div class="timer-wrapper" id="timerSection">
              <div class="timer-circle">
                <svg width="120" height="120" viewBox="0 0 120 120">
                  <circle class="timer-bg" cx="60" cy="60" r="54" />
                  <circle class="timer-progress" cx="60" cy="60" r="54" stroke-dasharray="339.292" stroke-dashoffset="0" />
                </svg>
                <div class="timer-text" id="timerCount">15</div>
              </div>
              <div class="timer-label">Thời gian ước tính (phút)</div>
            </div>

            <div class="order-items">
              <h4>Các món đã đặt:</h4>
              <ul id="orderItemsList">
                <!-- Order items will be loaded here -->
              </ul>
            </div>
            
            <div class="total-amount">
              <p>Tổng tiền: <span id="orderTotal">0đ</span></p>
              <p>Phương thức thanh toán: <span id="paymentMethod">Chưa xác định</span></p>
            </div>
          </div>

          <div class="order-history">
            <h3>Lịch Sử Đơn Hàng</h3>
            <div class="history-list" id="orderHistory">
              <!-- Order history will be loaded here -->
              <div class="empty-state" id="emptyHistory">
                <i class="fas fa-history"></i>
                <h4>Chưa có đơn hàng nào</h4>
                <p>Các đơn hàng của bạn sẽ xuất hiện ở đây</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <div id="footer-container"></div>
  </div>
  
  <script>
    // Function to load components
    async function loadComponent(url, containerId) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Failed to fetch ${url}: ${response.status}`);
            }
            const html = await response.text();
            document.getElementById(containerId).innerHTML = html;
            
            // Execute scripts in the loaded HTML
            const scripts = document.getElementById(containerId).querySelectorAll('script');
            scripts.forEach(script => {
                const newScript = document.createElement('script');
                if (script.src) {
                    newScript.src = script.src;
                } else {
                    newScript.textContent = script.textContent;
                }
                document.body.appendChild(newScript);
            });
        } catch (error) {
            console.error('Error loading component:', error);
            document.getElementById(containerId).innerHTML = `<div style="color: red; padding: 20px;">Failed to load component: ${error.message}</div>`;
        }
    }
    
    // Đảm bảo tải components khi trang đã tải xong
    document.addEventListener('DOMContentLoaded', function() {
        // Load header và footer
        loadComponent('../components/header.html', 'header-container');
        loadComponent('../components/footer.html', 'footer-container');
    });
  </script>

  <script>
    // Đảm bảo trang xử lý tốt lỗi API
    window.addEventListener('error', function(event) {
        // Kiểm tra lỗi Failed to fetch để hiển thị thông báo thân thiện
        if (event.error && event.error.message && event.error.message.includes('Failed to fetch')) {
            console.warn('Đã xử lý lỗi fetchAPI:', event.error.message);
            // Ngăn lỗi hiển thị trong console
            event.preventDefault();
        }
    });

    // Khởi tạo giá trị mặc định cho CafeAPI nếu chưa được tạo
    if (!window.CafeAPI) {
        console.warn('window.CafeAPI không tồn tại, tạo phiên bản giả lập');
        window.CafeAPI = {
            checkApiConnection: async function() {
                console.warn('Sử dụng checkApiConnection giả lập');
                return { available: false, status: 0, statusText: 'API không được khởi tạo đúng cách' };
            },
            getOrderById: async function() {
                console.warn('Sử dụng getOrderById giả lập');
                throw new Error('API không được khởi tạo đúng cách');
            },
            getOrdersByStatus: async function() {
                console.warn('Sử dụng getOrdersByStatus giả lập');
                return [];
            },
            getRecentOrders: async function() {
                console.warn('Sử dụng getRecentOrders giả lập');
                return [];
            },
            getOrderStatus: async function() {
                console.warn('Sử dụng getOrderStatus giả lập');
                return 'processing';
            },
            convertOrderFromServer: function(serverOrder) {
                return serverOrder || {};
            }
        };
    }
  </script>

  <script src="../assets/js/main.js"></script>
  <script src="../assets/js/api.js"></script>
  <script src="../assets/js/status.js"></script>
</body>

</html>