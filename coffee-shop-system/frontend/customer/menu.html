<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu - T2K Coffee</title>
    <link rel="stylesheet" href="../assets/css/menu.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/customer/menu.js"></script>
</head>

<body>
    <div id="app">
        <!-- Header will be loaded dynamically -->
        <div id="header-container"></div>
        
        <main class="menu-page">
            <div class="container">
                <h1 class="page-title">T2K Coffee Menu</h1>
                
                <!-- Add toggle cart button for mobile -->
                <div class="toggle-cart" id="toggleCartBtn">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count" id="mobileCartCount">0</span>
                </div>
                
                <div class="category-tabs" id="categoryTabs">
                    <!-- Categories will be loaded here -->
                    <button class="category-tab active" data-category="all">Tất cả</button>
                    <button class="category-tab" data-category="1">Cà phê</button>
                    <button class="category-tab" data-category="2">Trà</button>
                    <button class="category-tab" data-category="3">Bánh</button>
                    <button class="category-tab" data-category="4">Tráng miệng</button>
                    <button class="category-tab" data-category="5">Sinh tố</button>
                </div>
                
                <div class="container-wrapper">
                    <div class="menu-container">
                        <div id="menuContainer">
                            <div class="loading">
                                <i class="fas fa-spinner"></i> Đang tải sản phẩm...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Order Panel -->
                    <div class="order-panel" id="orderPanel">
                        <div class="cart-header">
                            <div class="cart-title">
                                <i class="fas fa-shopping-cart"></i> Giỏ hàng
                                <span class="cart-badge" id="cartCountBadge">0</span>
                            </div>
                            <div class="order-panel-actions">
                                <button id="clearCartBtn" title="Xóa giỏ hàng" style="background: none; border: none; cursor: pointer;">
                                    <i class="fas fa-trash" style="color: #e74c3c;"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="cart-items">
                            <div id="cartItemsPreview">
                                <p style="text-align: center; color: #7f8c8d; padding: 20px 0;">
                                    Giỏ hàng trống
                                </p>
                            </div>
                        </div>
                        
                        <div class="table-selection">
                            <label for="tableSelect">Số bàn (Tại chỗ - Tùy chọn):</label>
                            <select id="tableSelect">
                                <option value="">Tại chỗ (không chọn bàn cụ thể)</option>
                                <option value="takeaway">Mang đi</option>
                            </select>
                        </div>
                        
                        <div class="order-summary">
                            <div class="total-row">
                                <span>Tổng:</span>
                                <span id="orderTotal">0 đ</span>
                            </div>
                        </div>
                        
                        <button class="proceed-btn" id="proceedBtn">
                            Thanh toán
                        </button>
                    </div>
                </div>
        </div>
    </main>
        
        <!-- Footer will be loaded dynamically -->
        <div id="footer-container"></div>
    </div>

    <script>
        // Function to load components
        async function loadComponent(url, containerId) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${url}: ${response.status}`);
                }
                const html = await response.text();
                document.getElementById(containerId).innerHTML = html;
                
                // Execute scripts in the loaded HTML
                const scripts = document.getElementById(containerId).querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    document.body.appendChild(newScript);
                });
            } catch (error) {
                console.error('Error loading component:', error);
                document.getElementById(containerId).innerHTML = `<div style="color: red; padding: 20px;">Không thể tải thành phần: ${error.message}</div>`;
            }
        }
        
        // Load header and footer components
        document.addEventListener('DOMContentLoaded', () => {
            loadComponent('../components/header.html', 'header-container');
            loadComponent('../components/footer.html', 'footer-container');
        });
    </script>
    
    <!-- Token Handler Script -->
    <script>
        // Script để đảm bảo token được gửi đúng cách với mỗi request
        document.addEventListener('DOMContentLoaded', function() {
            // Kiểm tra token
            const token = localStorage.getItem('token');
            const role = localStorage.getItem('role');
            
            console.log("Current auth status:", {
                hasToken: !!token,
                tokenFirstChars: token ? token.substring(0, 15) + '...' : 'none',
                role: role || 'none'
            });
            
            // Thêm interceptor cho tất cả các fetch requests
            const originalFetch = window.fetch;
            window.fetch = function(url, options = {}) {
                // Tạo options nếu không có
                options = options || {};
                // Tạo headers nếu không có
                options.headers = options.headers || {};
                
                // Chỉ thêm token nếu URL là API endpoint
                if (typeof url === 'string' && (url.includes('/api/') || url.includes('localhost:8081'))) {
                    // Kiểm tra nếu là API công khai
                    const isPublicAPI = 
                        url.includes('/api/tables') || 
                        url.includes('/api/products') || 
                        url.includes('/api/promotions') ||
                        url.includes('/api/categories') ||
                        url.includes('/api/accounts/login') ||
                        url.includes('/api/accounts/register');
                    
                    // Chỉ thêm token nếu không phải là API công khai hoặc nếu có token
                    if (token) {
                        options.headers['Authorization'] = `Bearer ${token}`;
                        console.log(`Added token to request: ${url}`);
                    } else if (!isPublicAPI) {
                        console.warn(`Request to authenticated endpoint without token: ${url}`);
                    }
                    
                    // Thêm CORS và credentials cho tất cả API requests
                    options.mode = 'cors';
                    options.credentials = 'include';
                }
                
                return originalFetch(url, options);
            };
            
            console.log("Fetch interceptor installed for API requests");
        });
    </script>
</body>

</html>